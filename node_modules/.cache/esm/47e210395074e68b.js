let path,promisify,fs,axios,yaml,shell,Docker,chalk,boxen,check,compareVersions;_507‍.x([["BF_CONFIG_DIR",()=>BF_CONFIG_DIR],["BF_CONFIG_FILE",()=>BF_CONFIG_FILE],["DOCKER_COMPOSE_TEMPLATE_FILENAME",()=>DOCKER_COMPOSE_TEMPLATE_FILENAME],["DOCKER_COMPOSE_FILENAME",()=>DOCKER_COMPOSE_FILENAME],["DEFAULT_MODEL_FILENAME",()=>DEFAULT_MODEL_FILENAME],["ENV_FILENAME",()=>ENV_FILENAME],["fixDir",()=>fixDir],["consoleError",()=>consoleError],["startSpinner",()=>startSpinner],["setSpinnerText",()=>setSpinnerText],["setSpinnerInfo",()=>setSpinnerInfo],["succeedSpinner",()=>succeedSpinner],["failSpinner",()=>failSpinner],["stopSpinner",()=>stopSpinner],["getLatestVersion",()=>getLatestVersion],["getProjectVersion",()=>getProjectVersion],["getMongoPassword",()=>getMongoPassword],["isMinorUpdateWithVersion",()=>isMinorUpdateWithVersion],["isMajorUpdateWithVersion",()=>isMajorUpdateWithVersion],["isMinorUpdate",()=>isMinorUpdate],["isMajorUpdate",()=>isMajorUpdate],["shouldUpdateNpmPackageWithVersions",()=>shouldUpdateNpmPackageWithVersions],["shouldUpdateNpmPackage",()=>shouldUpdateNpmPackage],["displayNpmUpdateMessage",()=>displayNpmUpdateMessage],["displayProjectUpdateMessage",()=>displayProjectUpdateMessage],["updateProjectFile",()=>updateProjectFile],["updateEnvFile",()=>updateEnvFile],["getComposeTemplateFile",()=>getComposeTemplateFile],["generateDockerCompose",()=>generateDockerCompose],["getProjectConfig",()=>getProjectConfig],["verifySystem",()=>verifySystem],["getCommunicoVersion",()=>getCommunicoVersion],["isPrivate",()=>isPrivate],["getComposeFilePath",()=>getComposeFilePath],["getGeneratedComposeFilePath",()=>getGeneratedComposeFilePath],["getProjectInfoDirPath",()=>getProjectInfoDirPath],["getProjectInfoFilePath",()=>getProjectInfoFilePath],["getProjectEnvFilePath",()=>getProjectEnvFilePath],["isProjectDir",()=>isProjectDir],["getComposeFile",()=>getComposeFile],["getGeneratedComposeFile",()=>getGeneratedComposeFile],["getServices",()=>getServices],["getMissingImgs",()=>getMissingImgs],["getServiceNames",()=>getServiceNames],["getDefaultServiceNames",()=>getDefaultServiceNames],["getService",()=>getService],["getExternalPort",()=>getExternalPort],["getContainerAndImageNames",()=>getContainerAndImageNames],["getServiceUrl",()=>getServiceUrl],["getComposeWorkingDir",()=>getComposeWorkingDir],["wait",()=>wait],["capitalize",()=>capitalize],["shellAsync",()=>shellAsync],["waitForService",()=>waitForService],["randomString",()=>randomString]]);_507‍.w("path",[["default",["path"],function(v){path=v}]]);_507‍.w("util",[["promisify",["promisify"],function(v){promisify=v}]]);_507‍.w("fs",[["default",["fs"],function(v){fs=v}]]);_507‍.w("axios",[["default",["axios"],function(v){axios=v}]]);_507‍.w("js-yaml",[["default",["yaml"],function(v){yaml=v}]]);_507‍.w("shelljs",[["default",["shell"],function(v){shell=v}]]);_507‍.w("docker-cli-js",[["Docker",["Docker"],function(v){Docker=v}]]);_507‍.w("chalk",[["default",["chalk"],function(v){chalk=v}]]);_507‍.w("boxen",[["default",["boxen"],function(v){boxen=v}]]);_507‍.w("check-node-version",[["default",["check"],function(v){check=v}]]);_507‍.w("compare-version",[["default",["compareVersions"],function(v){compareVersions=v}]]);




       const BF_CONFIG_DIR = '.communico';
       const BF_CONFIG_FILE = 'communico.yml';
       const DOCKER_COMPOSE_TEMPLATE_FILENAME = 'docker-compose-template.yml';
       const DOCKER_COMPOSE_FILENAME = 'docker-compose.yml';
       const DEFAULT_MODEL_FILENAME = 'default_model.tar.gz';
       const ENV_FILENAME = '.env';







       function fixDir(dir) {
    return dir ? dir : process.cwd();
}

       function consoleError(error) {
    try {
        _507‍.g.console.log(boxen(error));
    } catch (e) {
        _507‍.g.console.log(error);
    }
}

       function startSpinner(spinner, message) {
    if (spinner) {
        spinner.start(message);
    } else {
        _507‍.g.console.log(message);
    }
}

       function setSpinnerText(spinner, message) {
    if (spinner) {
        spinner.text = message;
    } else {
        _507‍.g.console.log(message);
    }
}

       function setSpinnerInfo(spinner, message) {
    if (spinner) {
        spinner.info = message;
    } else {
        _507‍.g.console.log(message);
    }
}

       function succeedSpinner(spinner, message) {
    if (spinner) {
        spinner.succeed(message);
    } else {
        _507‍.g.console.log(message);
    }
}

       function failSpinner(spinner, message, params = {}) {
    const { exit = true } = params;
    if (spinner) {
        spinner.fail(message);
    } else {
        _507‍.g.console.log(message);
    }
    if (exit) process.exit(1);
}

       function stopSpinner(spinner) {
    if (spinner) {
        spinner.stop();
    }
}

       async function getLatestVersion() {
    try {
        const response = await axios.get('https://registry.npmjs.org/communico');
        if (response.status === 200) {
            return response.data['dist-tags'].latest;
        }
        // If the call fails we just return the current version
        return getCommunicoVersion();
    } catch (e) {
        return getCommunicoVersion();
    }
}

       function getProjectVersion() {
    return getProjectConfig(fixDir(null)).version;
}

       function getMongoPassword() {
    return getProjectConfig(fixDir(null)).env.mongo_initdb_root_password;
}

       function isMinorUpdateWithVersion(projectVersion, communicoVersion) {
    const projectMajorVersion = projectVersion.split('.')[1];
    const projectMinorVersion = projectVersion.split('.')[2];
    const communicoMajorVersion = communicoVersion.split('.')[1];
    const communicoMinorVersion = communicoVersion.split('.')[2];
    return (
        projectMajorVersion === communicoMajorVersion &&
        communicoMinorVersion !== projectMinorVersion
    );
}

       function isMajorUpdateWithVersion(projectVersion, communicoVersion) {
    const projectMajorVersion = projectVersion.split('.')[1];
    const communicoMajorVersion = communicoVersion.split('.')[1];
    return compareVersions(communicoMajorVersion, projectMajorVersion) == 1;
}

       function isMinorUpdate() {
    const communicoVersion = getCommunicoVersion();
    const projectVersion = getProjectVersion();
    return isMinorUpdateWithVersion(projectVersion, communicoVersion);
}

       function isMajorUpdate() {
    const communicoVersion = getCommunicoVersion();
    const projectVersion = getProjectVersion();
    return isMajorUpdateWithVersion(projectVersion, communicoVersion);
}

       function shouldUpdateNpmPackageWithVersions(currentVersion, latestVersion) {
    return compareVersions(latestVersion, currentVersion) == 1;
}

       async function shouldUpdateNpmPackage() {
    if (isPrivate()) return false;
    const currentVersion = getCommunicoVersion();
    const latestVersion = await getLatestVersion();
    return shouldUpdateNpmPackageWithVersions(currentVersion, latestVersion);
}

       async function displayNpmUpdateMessage() {
    const shouldUpdate = await shouldUpdateNpmPackage();
    if (shouldUpdate) {
        const currentVersion = getCommunicoVersion();
        const latestVersion = await getLatestVersion();
        _507‍.g.console.log(
            boxen(
                `A new version of Communico is available: ${chalk.blueBright(
                    currentVersion,
                )} -> ${chalk.green(latestVersion)}\nRun ${chalk.cyan.bold(
                    'npm install -g communico',
                )} to update.`,
                { padding: 1, margin: 1 },
            ),
        );
    }
    return shouldUpdate;
}

       async function displayProjectUpdateMessage() {
    if (!isProjectDir()) return;
    let isMajorUpdate = false;

    const communicoVersion = getCommunicoVersion();
    const projectVersion = getProjectVersion();

    if (isMinorUpdateWithVersion(projectVersion, communicoVersion)) {
        _507‍.g.console.log(
            boxen(
                `Project was made with Communico ${chalk.blueBright(
                    projectVersion,
                )} and the currently installed version is ${chalk.green(
                    communicoVersion,
                )}\nRun ${chalk.cyan.bold('communico update')} to update your project.`,
            ),
        );
    }
    if (isMajorUpdateWithVersion(projectVersion, communicoVersion)) {
        _507‍.g.console.log(
            boxen(
                `Project was made with Communico ${chalk.blueBright(
                    projectVersion,
                )} and the currently installed version is ${chalk.green(
                    communicoVersion,
                )}, which is a major update.\nPlease follow the instructions in the migration guide: ${chalk.cyan.bold(
                    'https://communico.io/docs/installation/migration-guide/',
                )}.`,
            ),
        );
        isMajorUpdate = true;
    }
    return isMajorUpdate;
}

/*
Augment the communico.yml file with version and project specific values
*/
       function updateProjectFile({
    projectAbsPath,
    images,
    env = {},
    enableMongoAuth = false,
    leaveMongoUrl = false,
    mongoPassword = randomString(),
}) {
    const config = getProjectConfig(projectAbsPath);
    if (!config.version) {
        config.version = getCommunicoVersion();
    }

    if (images) {
        config.images.current = JSON.parse(JSON.stringify(config.images.default)); // deep copy
        Object.keys(config.images.current).forEach((service) => {
            if (images[service]) config.images.current[service] = images[service];
        });
    }
    config.env = {
        ...config.env || {},
        ...env,
    };
    if (!leaveMongoUrl) {
        if (enableMongoAuth) {
            Object.assign(config.env, {
                mongo_url: `mongodb://root:${mongoPassword}@mongo:27017/bf?authSource=admin`,
                mongo_initdb_root_username: 'root',
                mongo_initdb_root_password: mongoPassword,
            });
        } else {
            Object.assign(config.env, {
                mongo_url: 'mongodb://mongo:27017/bf',
            });
        }
    }

    fs.writeFileSync(getProjectInfoFilePath(projectAbsPath), yaml.safeDump(config));
}

       async function updateEnvFile(projectAbsPath) {
    const config = getProjectConfig(projectAbsPath);
    let envFileContent =
        '########################################################################\n';
    envFileContent +=
        '# This file is generated when `communico up` is invoked.                #\n';
    envFileContent +=
        '# You can change / add environment variables in .communico/communico.yml #\n';
    envFileContent +=
        '########################################################################\n\n';

    if (!config.env) {
        config.env = {};
    }

    Object.keys(config.env).forEach((variable) => {
        envFileContent += `${variable.toUpperCase()}=${config.env[variable]}\n`;
    });
    Object.keys(config.images.default).forEach((variable) => {
        envFileContent += `IMAGES_DEFAULT_${variable.toUpperCase().replace('-', '_')}=${
            config.images.default[variable]
        }\n`;
    });
    Object.keys(config.images.current).forEach((variable) => {
        envFileContent += `IMAGES_CURRENT_${variable.toUpperCase().replace('-', '_')}=${
            config.images.current[variable]
        }\n`;
    });

    fs.writeFileSync(getProjectEnvFilePath(projectAbsPath), envFileContent);
}

       const getComposeTemplateFile = dir => getComposeFile(dir, DOCKER_COMPOSE_TEMPLATE_FILENAME);

       function generateDockerCompose(exclude = [], dir, projectId) {
    let initContent =
        '######################################################################################################\n';
    initContent +=
        '# This file is generated when `communico up` is invoked.                                              #\n';
    initContent +=
        '# Changes in .communico/communico.yml and .communico/docker-compose-template.yml will be reflected here #\n';
    initContent +=
        '######################################################################################################\n\n';

    const dc = getComposeTemplateFile(dir);
    exclude.forEach((excl) => {
        // remove reference to excluded services
        if (excl in dc.services) delete dc.services[excl];
        Object.values(dc.services).forEach((service) => {
            if ({}.hasOwnProperty.call(service, 'depends_on')) {
                service.depends_on = service.depends_on.filter(
                    (depend) => depend !== excl,
                );
                if (service.depends_on.length === 0) delete service.depends_on;
            }
        });
    });
    const config = getProjectConfig(dir);
    const dcCopy = JSON.parse(JSON.stringify(dc));
    Object.keys(dc.services)
        .filter((service) => ['actions', 'rasa'].indexOf(service) < 0)
        .forEach((service) => {
            dcCopy.services[service].image = config.images.current[service];
        });
    if (projectId) { // hot update of projectId
        ['actions', 'rasa'].forEach(service => {
            if (!(service in dc.services)) return;
            dcCopy.services[service].environment = [
                ...(dcCopy.services[service].environment || []),
                `BF_PROJECT_ID=${projectId}`,
            ];
        })
    }
    fs.writeFileSync(
        getGeneratedComposeFilePath(dir),
        `${initContent}${yaml.safeDump(dcCopy)}`,
    );
    return true;
}

       function getProjectConfig(projectAbsPath) {
    return yaml.safeLoad(
        fs.readFileSync(getProjectInfoFilePath(projectAbsPath), 'utf-8'),
    );
}

       async function verifySystem() {
    const docker = new Docker();
    const result = await docker.command('info');
    // const version = result.object.server_version;
    if (!result.object)
        throw `You must install Docker to use Communico. Please visit ${chalk.green(
            'https://www.docker.com/products/docker-desktop',
        )}`;
    const results = await promisify(check)({ node: '>= 8.9' });
    if (!results.versions.node.isSatisfied) {
        throw `You must upgrade your Node.js installation to use Communico. Please visit ${chalk.green(
            'https://nodejs.org/en/download/',
        )}`;
    }
}

       function getCommunicoVersion() {
    return JSON.parse(
        fs.readFileSync(path.join(__dirname, '../../communico/package.json')),
    ).version;
}

       function isPrivate() {
    return JSON.parse(fs.readFileSync(path.join(__dirname, '../../communico/package.json'))).private;
}

       function getComposeFilePath(dir, fileName = DOCKER_COMPOSE_FILENAME) {
    return path.join(fixDir(dir), BF_CONFIG_DIR, fileName);
}

       function getGeneratedComposeFilePath(dir, fileName = DOCKER_COMPOSE_FILENAME) {
    return path.join(fixDir(dir), fileName);
}
       function getProjectInfoDirPath(dir) {
    return path.join(fixDir(dir), BF_CONFIG_DIR);
}

       function getProjectInfoFilePath(dir) {
    return path.join(fixDir(dir), BF_CONFIG_DIR, BF_CONFIG_FILE);
}

       function getProjectEnvFilePath(dir) {
    return path.join(fixDir(dir), ENV_FILENAME);
}

       function isProjectDir(dir) {
    return fs.existsSync(
        getComposeFilePath(fixDir(dir), DOCKER_COMPOSE_TEMPLATE_FILENAME),
    );
}

       function getComposeFile(dir, fileName) {
    return yaml.safeLoad(fs.readFileSync(getComposeFilePath(dir, fileName), 'utf-8'));
}

       function getGeneratedComposeFile(dir, fileName) {
    return yaml.safeLoad(
        fs.readFileSync(getGeneratedComposeFilePath(dir, fileName), 'utf-8'),
    );
}

       function getServices(dir) {
    const services = getGeneratedComposeFile(dir).services;
    return Object.keys(services)
        .filter((s) => !!services[s].image)
        .map((s) => services[s].image);
}

       async function getMissingImgs(dir) {
    const docker = new Docker({});
    let availableImgs = await docker.command(
        'images --format "{{.Repository}}:{{.Tag}}"',
    );
    availableImgs = availableImgs.raw.split('\n');
    return getServices(dir).filter((service) => !availableImgs.includes(service));
}

       function getServiceNames(dir) {
    const services = getGeneratedComposeFile(dir).services;
    return Object.keys(services);
}

       function getDefaultServiceNames(dir) {
    const services = getComposeFile(dir, DOCKER_COMPOSE_TEMPLATE_FILENAME).services;
    return Object.keys(services);
}

       function getService(serviceName, dir) {
    return getGeneratedComposeFile(dir).services[serviceName];
}

       function getExternalPort(serviceName, dir) {
    return getService(serviceName, dir).ports[0].split(':')[0];
}

       function getContainerAndImageNames(dir, services) {
    let svcs = services || getComposeFile(dir).services;
    return {
        containers: Object.keys(svcs).map((s) => services[s].container_name),
        images: Object.keys(svcs).map((s) => services[s].image),
    };
}

       function getServiceUrl(serviceName) {
    return `http://localhost:${getExternalPort(serviceName)}`;
}

       function getComposeWorkingDir(workingDirectory) {
    return workingDirectory ? workingDirectory : './';
}

       async function wait(millis) {
    return promisify(setTimeout)(millis);
}

       function capitalize(s) {
    if (typeof s !== 'string') return '';
    return s.charAt(0).toUpperCase() + s.slice(1);
}

       async function shellAsync(command, options) {
    return promisify(shell.exec)(command, options);
}

       async function waitForService(serviceName) {
    const serviceUrl = getServiceUrl(serviceName);
    return new Promise((resolve, reject) => {
        const interval = setInterval(async () => {
            setTimeout(function () {
                reject();
            }, 90000);

            let response;
            try {
                response = await axios.get(serviceUrl);
            } catch (e) {
                response = e.response;
            }
            if (response && [200, 404].includes(response.status)) {
                clearInterval(interval);
                return resolve();
            }
        }, 1000);
    });
}

       function randomString(length = 12) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}
